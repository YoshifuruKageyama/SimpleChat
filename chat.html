<!DOCTYPE html>
<html>
<head>
    <title>chat</title>
    <script src="https://code.jquery.com/jquery-3.2.1.js"
            integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE="
            crossorigin="anonymous"></script>
    <style rel="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"></style>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.js"></script>
    <script>
        var index = 0;
        var main_clint;
        var sub_clints = [];
        function createCliant() {
            var socket = io.connect();
            index++;
            sub_clints[index] = { socket: socket, index: index };
            console.log("create cli " + sub_clints[index].index);
            socket.on("greeting", function (data) {
                console.log(data);
            });
            socket.on("user_list", function (data, fn) {
                console.log(data);
            });

            socket.on("error", function (data) {
                console.log(data);
            });

            return socket;
        }

        function closeCliant() {
            console.log("close");
            main_clint.close();
            main_clint.disconnect();
        }


        function createCliants(num) {
            for (var i = 0; num > i; i++) {
                createCliant();
            }
        }

        $(function () {
            $("a button#submit").click(function () {
                var send_message = $("input#send").val();
                if (!(send_message == null || send_message == "")) {
                    main_clint.emit("say_all", { message: send_message });
                }
                $("input#send").val("");
            });
            $("a button#create").click(function () {
                createCliant();
            });
            $("a button#disconnect").click(function () {
                closeCliant(100);
            });
            $("a button#get_user_list").click(function () {
                main_clint.emit("user_list", { message: null });
            });
            main_clint = createAdminClient();
            createCliants(5);
        });


        function createAdminClient() {
            var socket;

            $(function () {
                socket = io.connect();
                $("div#admin button#auth").click(function () {
                    var send_message = $("input#auth_key").val();
                    if (!(send_message == null || send_message == "")) {
                        socket.emit("authentication", { auth_key: send_message });
                    }
                });

                $("div#admin button#submit").click(function () {
                    var send_message = $("input#send").val();
                    if (!(send_message == null || send_message == "")) {
                        socket.emit("say_all", { message: send_message });
                    }
                    $("input#send").val("");
                });

                socket.on("authentication_complete", function (data) {
                    $("div#admin span.init_show").hide();
                    $("div#admin span.init_hidden").show();
                });

                socket.on("greeting", function (data, fn) {
                    console.log(fn, data.time_stamp, +new Date());
                });

                socket.on("user_list", function (data, fn) {
                    $("div#admin select#user_list").empty();
                    data = JSON.parse(data);
                    data.forEach(function (user) {
                        if (user == socket.id) {
                        } else {
                            $("div#admin select#user_list").append("<option value=\""+ user +"\">" + user + "</option>");
                        }                   
                    });
                });

                $("div#admin button#get_user_list").click(function () {
                    socket.emit("user_list", { message: null });
                });

                $("div#admin button#send_to").click(function () {
                    var send_user = $("select#user_list").val();
                    var send_message = $("input#send").val();
                    console.log({ send_to: send_user, message: send_message });
                    if (!(send_user == null || send_user == "" || send_message == null || send_message == "")) {
                        socket.emit("say_user", { send_to: send_user, message: send_message  });
                    }
                });

                $("div#admin button#kick_to").click(function () {
                    var send_user = $("select#user_list").val();
                    if (!(send_user == null || send_user == "")) {
                        socket.emit("kick", { send_to: send_user});
                    }
                });

                socket.on("error", function (data) {
                    sockte.close();
                    console.log(data);
                });
            });
            return socket;
        }
    </script>
</head>
<body>
    <div id="admin">
        <strong>アドミンクライアント</strong><br>
        <span class="init_show">
            key<input type="text" id="auth_key"><button id="auth">認証</button>
        </span>
        <span class="init_hidden" style="display: none;">
            <input type="text" id="send"><button id="submit">しゃべる</button>
            <button id="create">接続</button>
            <button id="disconnect">切断</button>
            <button id="get_user_list">ユーザ一覧取得</button>
            <select id="user_list" size="10"></select>
            <button id="kick_to">指定ユーザを切断</button>
            <button id="send_to">指定ユーザに発言</button>
        </span>
    </div>
</body>
</html>